<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SNAKE EVOLUTION: COLLISION FIX</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Black+Han+Sans&family=Pretendard:wght@400;700;900&family=Nanum+Pen+Script&display=swap');
        
        body {
            background-color: #0f172a;
            font-family: 'Pretendard', sans-serif;
            margin: 0;
            overflow: hidden;
            color: white;
            touch-action: none;
        }
        .font-title { font-family: 'Black Han Sans', sans-serif; }
        .font-chalk { font-family: 'Nanum Pen Script', cursive; }
        
        #game-container {
            width: 100vw;
            height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .screen {
            display: none;
            flex-direction: column;
            align-items: center;
            width: 100%;
            height: 100%;
            padding: 1rem;
            overflow-y: auto;
        }

        .screen.active { display: flex; }

        #canvas-wrapper {
            position: relative;
            width: 100%;
            max-width: 800px;
            aspect-ratio: 16 / 10;
            overflow: hidden;
            border: 4px solid #334155;
            border-radius: 12px;
            background-color: #020617;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }

        canvas { display: block; width: 100%; height: 100%; cursor: crosshair; }

        #battle-chat {
            position: absolute;
            bottom: 10px;
            left: 10px;
            width: 200px;
            height: 120px;
            background: rgba(15, 23, 42, 0.7);
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            font-size: 11px;
            z-index: 100;
            border: 1px solid rgba(255,255,255,0.1);
            pointer-events: auto;
        }

        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 5px;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .chat-input {
            background: rgba(0,0,0,0.3);
            border: none;
            border-top: 1px solid rgba(255,255,255,0.1);
            padding: 5px;
            color: white;
            outline: none;
            font-size: 11px;
            border-radius: 0 0 8px 8px;
        }

        .drop-shadow-glow {
            filter: drop-shadow(0 0 10px rgba(59, 130, 246, 0.5));
        }

        .skin-card {
            transition: all 0.2s ease;
        }
        .skin-card:hover {
            transform: translateY(-5px);
        }

        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            10% { transform: translate(-1px, -2px) rotate(-1deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            30% { transform: translate(3px, 2px) rotate(0deg); }
            40% { transform: translate(1px, -1px) rotate(1deg); }
            50% { transform: translate(-1px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            70% { transform: translate(3px, 1px) rotate(-1deg); }
            80% { transform: translate(-1px, -1px) rotate(1deg); }
            90% { transform: translate(1px, 2px) rotate(0deg); }
            100% { transform: translate(1px, -2px) rotate(-1deg); }
        }

        .shaking {
            animation: shake 0.5s;
            animation-iteration-count: infinite;
        }

        /* Dash Effect Overlay */
        #dash-effect {
            position: absolute;
            inset: 0;
            pointer-events: none;
            box-shadow: inset 0 0 50px rgba(59, 130, 246, 0.0);
            transition: box-shadow 0.2s;
            z-index: 50;
        }
        #dash-effect.active {
            box-shadow: inset 0 0 100px rgba(59, 130, 246, 0.5);
        }

        /* Mobile Dash Button */
        #mobile-dash-btn {
            position: absolute;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            z-index: 101;
            user-select: none;
            touch-action: manipulation;
        }
        #mobile-dash-btn:active {
            background: rgba(59, 130, 246, 0.6);
            transform: scale(0.95);
        }

        /* Minimap */
        #minimap {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 150px;
            height: 150px;
            background: rgba(0, 0, 0, 0.6);
            border: 1px solid rgba(255,255,255,0.2);
            z-index: 90;
            border-radius: 4px;
        }

        /* Chalkboard Effect */
        .chalkboard {
            background-color: #1e3a29;
            background-image: 
                radial-gradient(#fff 5%, transparent 10%),
                radial-gradient(#fff 5%, transparent 10%);
            background-position: 0 0, 25px 25px;
            background-size: 50px 50px;
            background-blend-mode: overlay;
            box-shadow: inset 0 0 20px #000;
        }

        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #475569; border-radius: 10px; }
    </style>
</head>
<body>

<div id="game-container">
    <!-- Lobby Screen -->
    <div id="screen-lobby" class="screen active justify-center">
        <h1 class="font-title text-4xl md:text-6xl text-blue-400 mb-2 italic text-center drop-shadow-glow uppercase tracking-tighter">Snake Evolution</h1>
        <p class="text-slate-400 mb-8 text-center text-sm font-medium">ì—­ì‚¬ ë¬¸ì œë¥¼ ë§ì¶° ì§€ë ì´ë¥¼ ì„±ì¥ì‹œí‚¤ì„¸ìš”! <span class="text-xs bg-yellow-500 text-white px-2 py-0.5 rounded ml-2">ì´ˆ5-2 ì—­ì‚¬</span></p>
        
        <div class="mb-6 w-full max-w-sm">
            <label class="block text-xs font-bold text-slate-500 mb-2 px-2 uppercase tracking-widest">Your Legend Name</label>
            <input type="text" id="nickname-input" maxlength="10" placeholder="ë‹‰ë„¤ì„ ì…ë ¥..." 
                class="w-full bg-slate-800 border-2 border-slate-700 rounded-2xl px-6 py-4 text-lg font-bold focus:border-blue-500 outline-none transition-all shadow-inner">
            <div id="user-id-display" class="text-[10px] text-slate-600 mt-2 px-2 truncate font-mono">UID: CONNECTING...</div>
        </div>

        <div class="grid grid-cols-2 gap-4 w-full max-w-md mb-6">
            <button id="btn-start-single" class="bg-gradient-to-br from-emerald-600 to-teal-700 hover:from-emerald-500 hover:to-teal-600 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 active:scale-95 shadow-xl group">
                <span class="text-3xl group-hover:scale-125 transition-transform">ğŸ¤–</span>
                <span class="font-bold">ì‹±ê¸€ ëª¨ë“œ</span>
            </button>
            <button id="btn-start-multi" class="bg-gradient-to-br from-blue-600 to-indigo-700 hover:from-blue-500 hover:to-indigo-600 p-6 rounded-3xl flex flex-col items-center gap-2 transition-all hover:scale-105 active:scale-95 shadow-xl opacity-50 cursor-not-allowed group" disabled>
                <span class="text-3xl group-hover:scale-125 transition-transform">ğŸŒ</span>
                <span class="font-bold">ì˜¨ë¼ì¸ ëª¨ë“œ</span>
            </button>
        </div>

        <div class="flex flex-wrap justify-center gap-4 items-center mb-4">
            <button id="btn-goto-shop" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 rounded-2xl font-bold transition-all flex items-center gap-2">ğŸ›ï¸ ìŠ¤í‚¨ ìƒì </button>
            <button id="btn-goto-community" class="bg-slate-700 hover:bg-indigo-500 px-6 py-3 rounded-2xl font-bold transition-all flex items-center gap-2">ğŸ’¬ ì»¤ë®¤ë‹ˆí‹°</button>
            <button id="btn-goto-minigame-hub" class="bg-purple-600 hover:bg-purple-500 px-6 py-3 rounded-2xl font-bold transition-all animate-pulse flex items-center gap-2">ğŸ­ ë¯¸ë‹ˆê²Œì„</button>
        </div>
        
        <div class="bg-slate-800/80 backdrop-blur-sm px-6 py-3 rounded-2xl border border-slate-700 text-yellow-400 font-black shadow-lg">
            ğŸª™ <span id="lobby-coin">0</span>
        </div>
    </div>

    <!-- Community Screen -->
    <div id="screen-community" class="screen">
        <div class="w-full max-w-2xl flex justify-between items-center mb-6 pt-4">
            <button onclick="window.switchScreen('lobby')" class="text-slate-400 hover:text-white font-bold transition-colors">â† ë¡œë¹„</button>
            <h2 class="font-title text-3xl text-indigo-400 uppercase tracking-tight">Community</h2>
            <div class="w-10"></div>
        </div>
        <div class="w-full max-w-2xl bg-slate-800 p-4 rounded-2xl border border-slate-700 mb-6 shadow-xl">
            <div class="flex gap-2">
                <input type="text" id="comm-input" placeholder="ì»¤ë®¤ë‹ˆí‹°ì— ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”..." class="flex-grow bg-slate-900 border border-slate-700 rounded-xl px-4 py-3 text-sm outline-none focus:border-indigo-500 transition-all">
                <button id="btn-comm-post" class="bg-indigo-600 hover:bg-indigo-500 px-6 py-3 rounded-xl font-bold text-sm transition-all shadow-lg active:scale-95">ë“±ë¡</button>
            </div>
        </div>
        <div id="comm-posts" class="w-full max-w-2xl flex flex-col gap-3 pb-20"></div>
    </div>

    <!-- Minigame Hub Screen -->
    <div id="screen-minigame-hub" class="screen justify-center">
        <div class="w-full max-w-2xl text-center mb-8">
            <button onclick="window.switchScreen('lobby')" class="text-slate-500 hover:text-white mb-4 block mx-auto font-bold">â† ë¡œë¹„ë¡œ</button>
            <h2 class="font-title text-4xl text-purple-400 mb-2 uppercase italic">Minigame Hub</h2>
            <p class="text-slate-400">ì½”ì¸ì„ ë²Œ ìˆ˜ ìˆëŠ” ì§€ë£¨í•  í‹ˆ ì—†ëŠ” ê²Œì„ë“¤!</p>
        </div>
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-2xl pb-10">
            <button onclick="window.startMiniGame('feed')" class="bg-gradient-to-br from-pink-600 to-rose-700 p-8 rounded-[2.5rem] flex flex-col items-center gap-4 hover:scale-105 transition-all shadow-2xl border-b-8 border-rose-900">
                <span class="text-5xl">ğŸ­</span>
                <div class="text-center">
                    <div class="font-black text-xl">ì§€ë ì´ ë¨¹ì´ì£¼ê¸°</div>
                    <div class="text-xs text-rose-200 opacity-80">ìˆœë°œë ¥ ê´‘í´ ê²Œì„</div>
                </div>
            </button>
            <button onclick="window.startMiniGame('dodge')" class="bg-gradient-to-br from-amber-600 to-orange-700 p-8 rounded-[2.5rem] flex flex-col items-center gap-4 hover:scale-105 transition-all shadow-2xl border-b-8 border-orange-900">
                <span class="text-5xl">ğŸ’£</span>
                <div class="text-center">
                    <div class="font-black text-xl">í­íƒ„ í”¼í•˜ê¸°</div>
                    <div class="text-xs text-orange-200 opacity-80">ì§‘ì¤‘ë ¥ íšŒí”¼ ê²Œì„</div>
                </div>
            </button>
            <button onclick="window.startMiniGame('history')" class="md:col-span-2 bg-gradient-to-br from-green-700 to-emerald-800 p-8 rounded-[2.5rem] flex flex-row items-center justify-center gap-8 hover:scale-105 transition-all shadow-2xl border-b-8 border-emerald-950">
                <span class="text-6xl">ğŸ‘¨â€ğŸ«</span>
                <div class="text-left">
                    <div class="font-black text-2xl">ì—­ì‚¬ ì„ ìƒë‹˜</div>
                    <div class="text-sm text-emerald-200 opacity-80">ì§€ë ì´ì—ê²Œ ì—­ì‚¬ë¥¼ ê°€ë¥´ì³ì£¼ì„¸ìš”!</div>
                </div>
            </button>
        </div>
    </div>

    <!-- Feed MiniGame Screen -->
    <div id="screen-minigame-feed" class="screen justify-center">
        <div id="minigame-feed-area" class="relative w-full max-w-2xl aspect-square bg-slate-900 border-4 border-pink-500/50 rounded-3xl overflow-hidden cursor-crosshair">
            <div id="mg-feed-timer" class="absolute top-4 left-4 bg-black/50 px-4 py-2 rounded-full font-black text-xl text-white z-10">30s</div>
            <div id="mg-feed-score" class="absolute top-4 right-4 bg-black/50 px-4 py-2 rounded-full font-black text-xl text-yellow-400 z-10">0</div>
            <div id="mg-feed-start-overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20">
                <button onclick="window.runMiniGameFeed()" class="bg-pink-500 hover:bg-pink-400 px-10 py-4 rounded-full font-black text-xl shadow-lg active:scale-95">ê²Œì„ ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- Dodge MiniGame Screen -->
    <div id="screen-minigame-dodge" class="screen justify-center">
        <div id="minigame-dodge-area" class="relative w-full max-w-2xl aspect-video bg-slate-950 border-4 border-orange-500/50 rounded-3xl overflow-hidden cursor-none">
            <div id="mg-dodge-timer" class="absolute top-4 left-4 bg-black/50 px-4 py-2 rounded-full font-black text-xl text-white z-10">30s</div>
            <div id="mg-dodge-score" class="absolute top-4 right-4 bg-black/50 px-4 py-2 rounded-full font-black text-xl text-yellow-400 z-10">0</div>
            <div id="dodge-player" class="absolute bottom-4 left-1/2 -translate-x-1/2 w-12 h-4 bg-blue-500 rounded-full transition-all duration-75"></div>
            <div id="mg-dodge-start-overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20">
                <button onclick="window.runMiniGameDodge()" class="bg-orange-500 hover:bg-orange-400 px-10 py-4 rounded-full font-black text-xl shadow-lg active:scale-95">ê²Œì„ ì‹œì‘</button>
            </div>
        </div>
        <p class="mt-4 text-slate-500 text-sm">ë§ˆìš°ìŠ¤ë¥¼ ì›€ì§ì—¬ ì§€ë ì´ë¥¼ ì¡°ì¢…í•˜ì„¸ìš”!</p>
    </div>

    <!-- History Teacher MiniGame Screen -->
    <div id="screen-minigame-history" class="screen justify-center">
        <div id="minigame-history-area" class="relative w-full max-w-2xl aspect-video chalkboard border-8 border-yellow-900 rounded-lg overflow-hidden flex flex-col items-center justify-center p-4">
            <div id="mg-history-timer" class="absolute top-4 left-4 font-chalk text-3xl text-white opacity-80">ë‚¨ì€ ì‹œê°„: 30ì´ˆ</div>
            <div id="mg-history-score" class="absolute top-4 right-4 font-chalk text-3xl text-yellow-400">ì ìˆ˜: 0</div>
            
            <div id="mg-history-content" class="w-full h-full flex flex-col items-center justify-center hidden">
                <div class="text-6xl mb-4">ğŸğŸ“</div>
                <div class="bg-white text-black p-4 rounded-2xl mb-6 relative w-full max-w-lg shadow-lg">
                    <div id="mg-history-q" class="font-bold text-lg text-center break-keep">ì§ˆë¬¸ì´ ì—¬ê¸°ì— ë‚˜ì˜µë‹ˆë‹¤.</div>
                    <div class="absolute bottom-[-10px] left-1/2 -translate-x-1/2 w-4 h-4 bg-white rotate-45"></div>
                </div>
                <div id="mg-history-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 w-full max-w-lg">
                    <!-- Options injected here -->
                </div>
            </div>

            <div id="mg-history-start-overlay" class="absolute inset-0 bg-black/80 flex flex-col items-center justify-center z-20">
                <h2 class="text-3xl font-chalk mb-4 text-emerald-400">ì§€ë ì´ ì—­ì‚¬ êµì‹¤</h2>
                <p class="text-slate-300 mb-8 text-center">ì§€ë ì´ê°€ ì—­ì‚¬ ì‹œí—˜ì„ ì˜ ë³¼ ìˆ˜ ìˆê²Œ<br>ì •ë‹µì„ ì•Œë ¤ì£¼ì„¸ìš”!</p>
                <button onclick="window.runMiniGameHistory()" class="bg-emerald-600 hover:bg-emerald-500 px-10 py-4 rounded-full font-black text-xl shadow-lg active:scale-95">ìˆ˜ì—… ì‹œì‘</button>
            </div>
        </div>
    </div>

    <!-- Shop Screen -->
    <div id="screen-shop" class="screen">
        <div class="w-full max-w-5xl flex flex-col md:flex-row justify-between items-center mb-8 pt-4 gap-4">
            <button onclick="window.switchScreen('lobby')" class="text-slate-400 hover:text-white font-bold">â† ë¡œë¹„ë¡œ</button>
            <h2 class="font-title text-4xl text-blue-400 italic tracking-tighter uppercase">Mega Skin Shop</h2>
            <div class="text-yellow-400 font-black bg-slate-800 px-6 py-3 rounded-full border border-slate-700 shadow-xl text-lg">
                ğŸª™ <span id="shop-coin">0</span>
            </div>
        </div>

        <div class="w-full max-w-5xl mb-10 bg-gradient-to-r from-blue-900/40 to-indigo-900/40 p-8 rounded-[2rem] border-2 border-indigo-500/30 flex flex-col md:flex-row items-center justify-between gap-6 shadow-2xl">
            <div class="flex items-center gap-6">
                <div class="text-6xl animate-bounce">ğŸ</div>
                <div>
                    <h3 class="font-black text-2xl text-white mb-1 uppercase italic">Random Skin Box</h3>
                    <p class="text-indigo-200 text-sm opacity-80">300ì½”ì¸ìœ¼ë¡œ í¬ê·€ ìŠ¤í‚¨ì„ íšë“í•˜ì„¸ìš”!</p>
                </div>
            </div>
            <button id="btn-gacha" class="bg-gradient-to-r from-yellow-500 to-orange-600 hover:from-yellow-400 hover:to-orange-500 px-10 py-4 rounded-2xl font-black text-xl text-white shadow-[0_10px_0_rgb(180,83,9)] active:translate-y-1 active:shadow-none transition-all">
                ë½‘ê¸° ğŸª™ 300
            </button>
        </div>

        <h4 class="w-full max-w-5xl mb-4 text-slate-500 font-bold uppercase tracking-widest text-xs px-2">Current Collection</h4>
        <div id="skin-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-5 gap-4 w-full max-w-5xl pb-20"></div>
    </div>

    <!-- Gacha Overlay -->
    <div id="gacha-overlay" class="fixed inset-0 bg-black/95 z-[5000] hidden flex flex-col items-center justify-center">
        <div id="gacha-box" class="text-9xl mb-10">ğŸ</div>
        <div id="gacha-result-text" class="text-center">
            <h2 class="text-3xl font-black text-white mb-2" id="gacha-status">í–‰ìš´ì˜ ìŠ¤í‚¨ ë°•ìŠ¤ ê°œë´‰ ì¤‘...</h2>
            <p class="text-slate-400 mb-8" id="gacha-sub-status">ë¬´ì—‡ì´ ë‚˜ì˜¬ê¹Œìš”?</p>
            <div id="gacha-new-skin" class="hidden">
                <div id="gacha-skin-preview" class="w-24 h-24 mx-auto rounded-full mb-4 shadow-2xl"></div>
                <h3 id="gacha-skin-name" class="text-4xl font-black text-blue-400 mb-8">ë‹‰ë„¤ì„</h3>
            </div>
            <button id="btn-gacha-close" class="hidden bg-white text-black px-12 py-4 rounded-full font-black text-xl hover:scale-105 transition-all">í™•ì¸</button>
        </div>
    </div>

    <!-- Battle Screen -->
    <div id="screen-battle" class="screen">
        <div class="w-full max-w-4xl flex justify-between items-end mb-2 px-2">
            <div>
                <div class="text-[10px] text-slate-400 font-bold uppercase tracking-widest" id="game-mode-display">MODE: SINGLE</div>
                <div class="flex items-baseline gap-2">
                    <div id="battle-score" class="text-4xl font-black text-emerald-400 leading-none">0</div>
                    <div id="battle-dash-text" class="text-xs text-blue-400 animate-pulse hidden">DASH!</div>
                </div>
            </div>
            <div class="flex gap-2">
                <div id="battle-coin-potential" class="text-lg font-bold text-yellow-400 bg-slate-800/80 px-4 py-2 rounded-2xl border border-slate-700">ğŸª™ 0</div>
                <button onclick="window.exitGame()" class="bg-red-600 hover:bg-red-500 text-white font-bold px-4 py-2 rounded-2xl text-sm transition-all shadow-lg active:scale-95">ë‚˜ê°€ê¸°</button>
            </div>
        </div>
        
        <div id="canvas-wrapper">
            <canvas id="gameCanvas"></canvas>
            
            <div id="dash-effect"></div>
            
            <!-- Minimap -->
            <canvas id="minimap" width="150" height="150"></canvas>

            <div id="battle-chat">
                <div id="chat-messages"></div>
                <input type="text" id="chat-input-field" class="chat-input" placeholder="ì±„íŒ… ì…ë ¥ (Enter)...">
            </div>

            <div id="mobile-dash-btn">âš¡</div>

            <div id="quiz-overlay" class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[92%] max-w-[450px] bg-white text-slate-900 p-8 rounded-[2rem] hidden z-[1000] shadow-2xl border-t-[10px] border-blue-500">
                <div class="flex justify-between items-start mb-4">
                    <span class="bg-blue-100 text-blue-600 text-xs font-bold px-2 py-1 rounded">ì´ˆ5-2 ì‚¬íšŒ</span>
                    <span class="text-slate-400 text-xs font-mono">HISTORY QUIZ</span>
                </div>
                <div id="quiz-question" class="text-xl font-black mb-6 leading-tight break-keep">...</div>
                <div id="quiz-options" class="flex flex-col gap-3"></div>
            </div>

            <div id="gameover-overlay" class="absolute inset-0 bg-slate-950/95 hidden flex-col items-center justify-center z-[2000] p-6 text-center">
                <div class="text-6xl mb-6">ğŸ’€</div>
                <h2 class="font-title text-5xl text-red-500 mb-2 italic">ì§€ë ì´ ì‚¬ë§</h2>
                <p class="text-slate-400 mb-6">ë²½ì´ë‚˜ ì ì— ì¶©ëŒí–ˆìŠµë‹ˆë‹¤!</p>
                <div id="final-coin-gain" class="text-4xl font-black text-yellow-400 mb-8">ğŸª™ 0</div>
                <button onclick="location.reload()" class="bg-white text-black px-12 py-4 rounded-full font-black text-xl shadow-lg active:scale-95">ë¡œë¹„ë¡œ ê·€í™˜</button>
            </div>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, addDoc, serverTimestamp, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    const appId = typeof __app_id !== 'undefined' ? __app_id : 'snake-evolution-v5-teachers';
    const state = {
        app: null, auth: null, db: null, user: null,
        userData: { nickname: "ì´ˆë³´ì§€ë ì´", coins: 0, unlockedSkins: ['blue'], selectedSkin: 'blue' },
        player: null, gameLoop: null, isPaused: true, gameMode: 'single',
        ais: [], remotePlayers: {}, foods: [], historyItems: [], magnets: [], score: 0, camera: { x: 0, y: 0 },
        activeMiniGame: null, mgInterval: null, mgScore: 0, mgTime: 30,
        lastMultiplayerUpdate: 0,
        unsubscribePlayers: null,
        isDashing: false
    };

    const CONFIG = {
        GRID_SIZE: 20, TILE_COUNT: 125, GACHA_PRICE: 300,
        SKINS: [
            { id: 'blue', name: 'ë² ì´ì§ ë¸”ë£¨', color: '#3b82f6', price: 0, rarity: 'common' },
            { id: 'purple', name: 'ê°¤ëŸ­ì‹œ í¼í”Œ', color: '#a855f7', price: 100, rarity: 'common' },
            { id: 'orange', name: 'ë„¤ì˜¨ ì˜¤ë Œì§€', color: '#f97316', price: 200, rarity: 'common' },
            { id: 'emerald', name: 'ì—ë©”ë„ë“œ', color: '#10b981', price: 500, rarity: 'rare' },
            { id: 'dragon', name: 'ë“œë˜ê³¤ ë ˆë“œ', color: '#ef4444', price: 1000, rarity: 'rare' },
            { id: 'diamond', name: 'ë‹¤ì´ì•„ëª¬ë“œ', color: '#22d3ee', price: 1500, rarity: 'legendary' },
            { id: 'gold', name: 'ë ˆì „ë”ë¦¬ ê³¨ë“œ', color: '#fbbf24', price: 2500, rarity: 'legendary' },
            { id: 'rainbow', name: 'ë ˆì¸ë³´ìš°', color: 'linear-gradient(to right, red, orange, yellow, green, blue, indigo, violet)', price: 5000, rarity: 'legendary' }
        ],
        QUIZZES: [
            { q: "ì¡°ì„  í›„ê¸°, ì‹¤ìƒí™œì— ë„ì›€ì´ ë˜ëŠ” í•™ë¬¸ì„ ì—°êµ¬í•˜ìëŠ” ì£¼ì¥ì€ ë¬´ì—‡ì¸ê°€ìš”?", a: ["ì„±ë¦¬í•™", "ì‹¤í•™", "ë¶ˆêµ", "ë„êµ"], c: 1 },
            { q: "ì¡°ì„  í›„ê¸° ì˜ì¡°ê°€ ë‹¹íŒŒ ì‹¸ì›€ì„ ì—†ì• ê³  ì¸ì¬ë¥¼ ê³ ë£¨ ë“±ìš©í•˜ê¸° ìœ„í•´ ì‹¤ì‹œí•œ ì •ì±…ì€?", a: ["íƒ•í‰ì±…", "ê³¨í’ˆì œ", "ê³¼ê±°ì œ", "í™”ë‘ë„"], c: 0 },
            { q: "ê¹€ì •í˜¸ê°€ ë§Œë“  ì§€ë„ë¡œ, ì˜¤ëŠ˜ë‚ ì˜ ì§€ë„ì™€ ë¹„ìŠ·í•˜ë©° ëª©íŒìœ¼ë¡œ ì¸ì‡„ëœ ê²ƒì€?", a: ["í˜¼ì¼ê°•ë¦¬ì—­ëŒ€êµ­ë„ì§€ë„", "ì²œí•˜ë„", "ëŒ€ë™ì—¬ì§€ë„", "íŒ”ë„ì´ë„"], c: 2 },
            { q: "í¥ì„  ëŒ€ì›êµ°ì´ ê²½ë³µê¶ì„ ë‹¤ì‹œ ì§“ê¸° ìœ„í•´ ë°œí–‰í•œ í™”íëŠ”?", a: ["ìƒí‰í†µë³´", "ë‹¹ë°±ì „", "ì¡°ì„ í†µë³´", "ê±´ì›ì¤‘ë³´"], c: 1 },
            { q: "1866ë…„ í”„ë‘ìŠ¤êµ°ì´ ê°•í™”ë„ë¥¼ ì¹¨ëµí•˜ì—¬ ì™¸ê·œì¥ê° ë„ì„œë¥¼ ì•½íƒˆí•´ ê°„ ì‚¬ê±´ì€?", a: ["ë³‘ì¸ì–‘ìš”", "ì‹ ë¯¸ì–‘ìš”", "ì„ì§„ì™œë€", "ë³‘ìí˜¸ë€"], c: 0 },
            { q: "1871ë…„ ë¯¸êµ°ì´ ê°•í™”ë„ì— ì¹¨ì…í•˜ì—¬ ì–´ì¬ì—° ì¥êµ° ë“±ì´ ë§ì„œ ì‹¸ìš´ ì‚¬ê±´ì€?", a: ["ìš´ìš”í˜¸ ì‚¬ê±´", "ì‹ ë¯¸ì–‘ìš”", "ë³‘ì¸ì–‘ìš”", "ì²­ì¼ì „ìŸ"], c: 1 },
            { q: "í¥ì„  ëŒ€ì›êµ°ì´ ì„œì–‘ê³¼ì˜ í†µìƒ ìˆ˜êµë¥¼ ê±°ë¶€í•˜ê² ë‹¤ëŠ” ì˜ì§€ë¥¼ ë‹´ì•„ ì„¸ìš´ ë¹„ì„ì€?", a: ["ê´‘ê°œí† ëŒ€ì™•ë¦‰ë¹„", "ì§„í¥ì™• ìˆœìˆ˜ë¹„", "ì²™í™”ë¹„", "ì¤‘ì›ê³ êµ¬ë ¤ë¹„"], c: 2 },
            { q: "1876ë…„ ì¡°ì„ ì´ ì¼ë³¸ê³¼ ë§ºì€ ìµœì´ˆì˜ ê·¼ëŒ€ì  ì¡°ì•½ì´ì ë¶ˆí‰ë“± ì¡°ì•½ì€?", a: ["ê°•í™”ë„ ì¡°ì•½", "ì„ì‚¬ëŠ‘ì•½", "í•œì¼ ì‹ í˜‘ì•½", "í…ì§„ ì¡°ì•½"], c: 0 },
            { q: "ê¹€ì˜¥ê·  ë“± ê¸‰ì§„ ê°œí™”íŒŒê°€ ê·¼ëŒ€ êµ­ê°€ë¥¼ ê±´ì„¤í•˜ê¸° ìœ„í•´ ì¼ìœ¼í‚¨ ì •ë³€ì€?", a: ["ì„ì˜¤êµ°ë€", "ê°‘ì‹ ì •ë³€", "ë™í•™ ë†ë¯¼ ìš´ë™", "ì„ë¯¸ì‚¬ë³€"], c: 1 },
            { q: "1894ë…„ ì „ë´‰ì¤€ì„ ì¤‘ì‹¬ìœ¼ë¡œ íƒê´€ì˜¤ë¦¬ì˜ íš¡í¬ì™€ ì™¸ì„¸ì˜ ì¹¨ëµì— ë§ì„œ ì¼ì–´ë‚œ ìš´ë™ì€?", a: ["3.1 ìš´ë™", "ë¬¼ì‚° ì¥ë ¤ ìš´ë™", "ë™í•™ ë†ë¯¼ ìš´ë™", "êµ­ì±„ ë³´ìƒ ìš´ë™"], c: 2 },
            { q: "1895ë…„ ì¼ë³¸ ë‚­ì¸ë“¤ì´ ê²½ë³µê¶ì— ì¹¨ì…í•˜ì—¬ ëª…ì„± í™©í›„ë¥¼ ì‹œí•´í•œ ì‚¬ê±´ì€?", a: ["ì„ë¯¸ì‚¬ë³€", "ì•„ê´€íŒŒì²œ", "í—¤ì´ê·¸ íŠ¹ì‚¬", "ì„ì˜¤êµ°ë€"], c: 0 },
            { q: "ê³ ì¢…ì´ ëŸ¬ì‹œì•„ ê³µì‚¬ê´€ìœ¼ë¡œ ê±°ì²˜ë¥¼ ì˜®ê¸´ ì‚¬ê±´ì„ ë¬´ì—‡ì´ë¼ê³  í•˜ë‚˜ìš”?", a: ["ê°•í™”ë„ ì¡°ì•½", "ì•„ê´€íŒŒì²œ", "ê°‘ì˜¤ê°œí˜", "ì„ì‚¬ëŠ‘ì•½"], c: 1 },
            { q: "ì„œì¬í•„ì´ ì¡°ì§í•˜ì—¬ ë…ë¦½ì‹ ë¬¸ì„ ì°½ê°„í•˜ê³  ë§Œë¯¼ ê³µë™íšŒë¥¼ ê°œìµœí•œ ë‹¨ì²´ëŠ”?", a: ["ì‹ ë¯¼íšŒ", "ë…ë¦½ í˜‘íšŒ", "ë³´ì•ˆíšŒ", "ëŒ€í•œ ìê°•íšŒ"], c: 1 },
            { q: "1905ë…„ ì¼ë³¸ì´ ëŒ€í•œ ì œêµ­ì˜ ì™¸êµê¶Œì„ ê°•ì œë¡œ ë¹¼ì•—ì€ ì¡°ì•½ì€?", a: ["ì •ë¯¸ 7ì¡°ì•½", "ì„ì‚¬ëŠ‘ì•½", "ê¸°ìœ ê°ì„œ", "í•œì¼ ì˜ì •ì„œ"], c: 1 },
            { q: "ì´í†  íˆë¡œë¶€ë¯¸ë¥¼ í•˜ì–¼ë¹ˆ ì—­ì—ì„œ ì‚¬ì‚´í•œ ë…ë¦½ìš´ë™ê°€ëŠ”?", a: ["ì´ë´‰ì°½", "ìœ¤ë´‰ê¸¸", "ì•ˆì¤‘ê·¼", "ê¹€êµ¬"], c: 2 },
            { q: "1919ë…„ 3ì›” 1ì¼, ë¯¼ì¡± ëŒ€í‘œ 33ì¸ê³¼ í•™ìƒë“¤ì´ ì£¼ë„í•˜ì—¬ ì¼ì–´ë‚œ ë…ë¦½ ë§Œì„¸ ìš´ë™ì€?", a: ["6.10 ë§Œì„¸ ìš´ë™", "ê´‘ì£¼ í•™ìƒ í•­ì¼ ìš´ë™", "3.1 ìš´ë™", "ì‹ ê°„íšŒ ì°½ë¦½"], c: 2 },
            { q: "3.1 ìš´ë™ ë‹¹ì‹œ ì•„ìš°ë‚´ ì¥í„°ì—ì„œ ë§Œì„¸ ì‹œìœ„ë¥¼ ì£¼ë„í•˜ë‹¤ ì²´í¬ë˜ì–´ ìˆœêµ­í•œ ì¸ë¬¼ì€?", a: ["ìœ ê´€ìˆœ", "ë‚¨ìí˜„", "ê¹€ë§ˆë¦¬ì•„", "ì•ˆì°½í˜¸"], c: 0 },
            { q: "í™ë²”ë„ ì¥êµ°ì´ ì´ë„ëŠ” ë…ë¦½êµ°ì´ ì¼ë³¸êµ°ì„ í¬ê²Œ ë¬´ì°Œë¥¸ ì „íˆ¬ëŠ”?", a: ["ì²­ì‚°ë¦¬ ëŒ€ì²©", "ë´‰ì˜¤ë™ ì „íˆ¬", "ëŒ€ì „ìë ¹ ì „íˆ¬", "ìŒì„±ë³´ ì „íˆ¬"], c: 1 },
            { q: "ì¼ì œê°€ ìš°ë¦¬ ë¯¼ì¡±ì˜ ë¬¸í™”ë¥¼ ë§ì‚´í•˜ê¸° ìœ„í•´ ìš°ë¦¬ë§ ì‚¬ìš©ì„ ê¸ˆì§€í•˜ê³  ì„±ê³¼ ì´ë¦„ì„ ì¼ë³¸ì‹ìœ¼ë¡œ ê³ ì¹˜ê²Œ í•œ ê²ƒì€?", a: ["ì°½ì”¨ê°œëª…", "í† ì§€ ì¡°ì‚¬ ì‚¬ì—…", "ì‚°ë¯¸ ì¦ì‹ ê³„íš", "ë‚¨ë©´ë¶ì–‘ ì •ì±…"], c: 0 },
            { q: "ëŒ€í•œë¯¼êµ­ ì„ì‹œ ì •ë¶€ë¥¼ ì´ëŒë©° í•œì¸ ì• êµ­ë‹¨ì„ ì¡°ì§í•œ ë…ë¦½ìš´ë™ê°€ëŠ”?", a: ["ì´ìŠ¹ë§Œ", "ì•ˆì°½í˜¸", "ê¹€êµ¬", "ì‹ ì±„í˜¸"], c: 2 },
            { q: "ìš°ë¦¬ë‚˜ë¼ê°€ ì¼ë³¸ì˜ ì‹ë¯¼ í†µì¹˜ì—ì„œ ë²—ì–´ë‚˜ ê´‘ë³µì„ ë§ì´í•œ ë‚ ì€?", a: ["1919ë…„ 3ì›” 1ì¼", "1945ë…„ 8ì›” 15ì¼", "1948ë…„ 8ì›” 15ì¼", "1950ë…„ 6ì›” 25ì¼"], c: 1 },
            { q: "1950ë…„ 6ì›” 25ì¼ ë¶í•œêµ°ì˜ ë‚¨ì¹¨ìœ¼ë¡œ ì‹œì‘ëœ ì „ìŸì€?", a: ["ì²­ì¼ ì „ìŸ", "ëŸ¬ì¼ ì „ìŸ", "6.25 ì „ìŸ", "ë² íŠ¸ë‚¨ ì „ìŸ"], c: 2 },
            { q: "1960ë…„ ì´ìŠ¹ë§Œ ì •ë¶€ì˜ ë¶€ì • ì„ ê±°ì— í•­ê±°í•˜ì—¬ ì¼ì–´ë‚œ ë¯¼ì£¼ì£¼ì˜ í˜ëª…ì€?", a: ["4.19 í˜ëª…", "5.18 ë¯¼ì£¼í™” ìš´ë™", "6ì›” ë¯¼ì£¼ í•­ìŸ", "ë¶€ë§ˆ ë¯¼ì£¼ í•­ìŸ"], c: 0 },
            { q: "1980ë…„ ê´‘ì£¼ì—ì„œ ì‹ êµ°ë¶€ì˜ ë¹„ìƒê³„ì—„ í™•ëŒ€ì— ë°˜ëŒ€í•˜ë©° ì¼ì–´ë‚œ ìš´ë™ì€?", a: ["4.19 í˜ëª…", "5.18 ë¯¼ì£¼í™” ìš´ë™", "6ì›” ë¯¼ì£¼ í•­ìŸ", "3.15 ì˜ê±°"], c: 1 },
            { q: "1987ë…„ ëŒ€í†µë ¹ ì§ì„ ì œ ê°œí—Œì„ ì´ëŒì–´ ë‚¸ ë¯¼ì£¼í™” ìš´ë™ì€?", a: ["4.19 í˜ëª…", "5.18 ë¯¼ì£¼í™” ìš´ë™", "6ì›” ë¯¼ì£¼ í•­ìŸ", "10.26 ì‚¬íƒœ"], c: 2 }
        ],
        AI_PERSONALITIES: [
            { type: 'aggressive', msg: ['ë¹„ì¼œ!', 'ë‹¤ ë¨¹ì–´ë²„ë¦°ë‹¤!', 'ê°íˆ ë‚  ë§‰ì•„?', 'ì „íˆ¬ ëª¨ë“œ!'] },
            { type: 'timid', msg: ['ì‚´ë ¤ì£¼ì„¸ìš”..', 'ë¬´ì„œì›Œìš”', 'ë‚œ ë§›ì—†ì–´', 'ë„ë§ê°€ì!'] },
            { type: 'chatty', msg: ['ì˜¤ëŠ˜ ë‚ ì”¨ ì¢‹ë„¤', 'ë„ˆ ìŠ¤í‚¨ ì˜ˆì˜ë‹¤', 'ê°™ì´ ë†€ì~', 'ë°°ê³ íŒŒ...'] }
        ]
    };

    // --- Core Functions ---
    window.switchScreen = (id) => {
        document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
        document.getElementById('screen-' + id).classList.add('active');
        if (id === 'lobby') updateUI();
    };
    
    window.exitGame = async () => {
        state.isPaused = true;
        clearInterval(state.gameLoop);
        
        // Multiplayer cleanup
        if (state.gameMode === 'multi' && state.user) {
             try {
                await deleteDoc(doc(state.db, 'artifacts', appId, 'public', 'data', 'players', state.user.uid));
             } catch(e) { console.error("Error cleaning up player:", e); }
             
             if(state.unsubscribePlayers) {
                 state.unsubscribePlayers();
                 state.unsubscribePlayers = null;
             }
        }
        
        window.switchScreen('lobby');
    };

    window.startMiniGame = (type) => {
        state.activeMiniGame = type;
        window.switchScreen('minigame-' + type);
        
        // Reset overlay
        const areaId = `minigame-${type}-area`;
        const area = document.getElementById(areaId);
        const resultOverlay = area.querySelector('.result-overlay');
        if(resultOverlay) resultOverlay.remove();

        document.getElementById(`mg-${type}-start-overlay`).classList.remove('hidden');
        if(type === 'history') document.getElementById('mg-history-content').classList.add('hidden');
        
        state.mgScore = 0;
        state.mgTime = 30;
        document.getElementById(`mg-${type}-score`).innerText = type === 'history' ? 'ì ìˆ˜: 0' : 0;
        document.getElementById(`mg-${type}-timer`).innerText = type === 'history' ? 'ë‚¨ì€ ì‹œê°„: 30ì´ˆ' : '30s';
    };

    window.runMiniGameFeed = () => {
        const overlay = document.getElementById('mg-feed-start-overlay');
        overlay.classList.add('hidden');
        const area = document.getElementById('minigame-feed-area');
        
        const spawnTarget = () => {
            if(state.mgTime <= 0) return;
            const dot = document.createElement('div');
            dot.className = "absolute w-12 h-12 rounded-full cursor-pointer flex items-center justify-center text-2xl transition-all active:scale-90 hover:scale-110";
            dot.style.left = Math.random() * (area.clientWidth - 50) + 'px';
            dot.style.top = Math.random() * (area.clientHeight - 50) + 'px';
            dot.style.background = `hsl(${Math.random()*360}, 70%, 50%)`;
            dot.innerText = "ğŸ­";
            dot.onclick = () => {
                state.mgScore++;
                document.getElementById('mg-feed-score').innerText = state.mgScore;
                dot.remove();
                spawnTarget();
            };
            area.appendChild(dot);
            setTimeout(() => { if(dot.parentElement) dot.remove(); }, 2000);
        };

        spawnTarget(); spawnTarget();
        state.mgInterval = setInterval(() => {
            state.mgTime--;
            document.getElementById('mg-feed-timer').innerText = state.mgTime + 's';
            if (state.mgTime <= 0) endMiniGame();
        }, 1000);
    };

    window.runMiniGameDodge = () => {
        const overlay = document.getElementById('mg-dodge-start-overlay');
        overlay.classList.add('hidden');
        const area = document.getElementById('minigame-dodge-area');
        const player = document.getElementById('dodge-player');
        
        area.onmousemove = (e) => {
            const rect = area.getBoundingClientRect();
            let x = e.clientX - rect.left - 24;
            x = Math.max(0, Math.min(x, area.clientWidth - 48));
            player.style.left = x + 'px';
        };

        const spawnObstacle = () => {
            if (state.mgTime <= 0) return;
            const obj = document.createElement('div');
            const isCoin = Math.random() > 0.7;
            obj.className = `absolute text-2xl top-0`;
            obj.innerText = isCoin ? "ğŸª™" : "ğŸ’£";
            obj.style.left = Math.random() * (area.clientWidth - 30) + 'px';
            area.appendChild(obj);

            let pos = 0;
            const fall = setInterval(() => {
                pos += isCoin ? 3 : 5;
                obj.style.top = pos + 'px';
                
                const pRect = player.getBoundingClientRect();
                const oRect = obj.getBoundingClientRect();
                
                if (oRect.bottom > pRect.top && oRect.left < pRect.right && oRect.right > pRect.left && oRect.top < pRect.bottom) {
                    if (isCoin) { state.mgScore += 2; } else { state.mgScore = Math.max(0, state.mgScore - 5); area.style.backgroundColor = '#450a0a'; setTimeout(()=>area.style.backgroundColor='#020617', 100); }
                    document.getElementById('mg-dodge-score').innerText = state.mgScore;
                    clearInterval(fall); obj.remove();
                }

                if (pos > area.clientHeight) { clearInterval(fall); obj.remove(); }
                if (state.mgTime <= 0) { clearInterval(fall); obj.remove(); }
            }, 16);
            
            setTimeout(spawnObstacle, isCoin ? 600 : 400);
        };

        spawnObstacle();
        state.mgInterval = setInterval(() => {
            state.mgTime--;
            document.getElementById('mg-dodge-timer').innerText = state.mgTime + 's';
            if (state.mgTime <= 0) endMiniGame();
        }, 1000);
    };

    window.runMiniGameHistory = () => {
        const overlay = document.getElementById('mg-history-start-overlay');
        overlay.classList.add('hidden');
        document.getElementById('mg-history-content').classList.remove('hidden');
        
        const showQuestion = () => {
            if (state.mgTime <= 0) return;
            const q = CONFIG.QUIZZES[Math.floor(Math.random() * CONFIG.QUIZZES.length)];
            document.getElementById('mg-history-q').innerText = q.q;
            const opts = document.getElementById('mg-history-options');
            opts.innerHTML = '';
            q.a.forEach((ans, idx) => {
                const btn = document.createElement('button');
                btn.className = "bg-slate-700 hover:bg-slate-600 p-3 rounded-lg text-sm font-bold transition-colors";
                btn.innerText = ans;
                btn.onclick = () => {
                    if (idx === q.c) {
                        state.mgScore += 10;
                        document.getElementById('mg-history-score').innerText = `ì ìˆ˜: ${state.mgScore}`;
                        btn.style.backgroundColor = '#10b981'; // Green
                    } else {
                        btn.style.backgroundColor = '#ef4444'; // Red
                    }
                    setTimeout(showQuestion, 200);
                };
                opts.appendChild(btn);
            });
        };

        showQuestion();
        state.mgInterval = setInterval(() => {
            state.mgTime--;
            document.getElementById('mg-history-timer').innerText = `ë‚¨ì€ ì‹œê°„: ${state.mgTime}ì´ˆ`;
            if (state.mgTime <= 0) endMiniGame();
        }, 1000);
    };

    // --- Snake Logic ---
    class Snake {
        constructor(id, x, y, skinId, name, isPlayer = false) {
            this.id = id;
            this.body = Array(5).fill(0).map((_, i) => ({ x: Math.floor(x), y: Math.floor(y) + i }));
            this.skin = CONFIG.SKINS.find(s => s.id === skinId) || CONFIG.SKINS[0];
            this.name = name;
            this.isPlayer = isPlayer;
            this.dx = 0; this.dy = -1;
            this.nextDx = 0; this.nextDy = -1;
            this.alive = true;
            this.personality = CONFIG.AI_PERSONALITIES[Math.floor(Math.random() * CONFIG.AI_PERSONALITIES.length)];
            this.chatMsg = null;
            this.chatTimer = 0;
            this.magnetTimer = 0;
        }
        update() {
            if (!this.alive) return;
            this.dx = this.nextDx; this.dy = this.nextDy;
            const head = { x: this.body[0].x + this.dx, y: this.body[0].y + this.dy };
            
            // Hardcore Wall Collision
            if (head.x < 0 || head.x >= CONFIG.TILE_COUNT || head.y < 0 || head.y >= CONFIG.TILE_COUNT) {
                this.die();
                return;
            }

            // Check collision with other snakes and self
            let collided = false;
            
            // 1. Self collision check (against current body segments)
            for(let part of this.body) {
                if(head.x === part.x && head.y === part.y) { collided = true; break; }
            }

            // 2. Check collision with others
            if(!collided) {
                // Determine potential colliders based on game mode
                const others = state.gameMode === 'multi' ? Object.values(state.remotePlayers) : state.ais;
                
                for(let other of others) {
                    if(other.id === this.id) continue; // Skip self if present in list
                    for(let part of other.body) {
                        if(head.x === part.x && head.y === part.y) { collided = true; break; }
                    }
                    if(collided) break;
                }

                // If I am an AI, I also need to check if I hit the Player
                if(!collided && !this.isPlayer && state.player && state.player.alive) {
                     for(let part of state.player.body) {
                        if(head.x === part.x && head.y === part.y) { collided = true; break; }
                    }
                }
                
                // If I am the Player, I also need to check if I hit AIs (in Single mode)
                if(!collided && this.isPlayer && state.gameMode === 'single') {
                    for(let ai of state.ais) {
                        for(let part of ai.body) {
                             if(head.x === part.x && head.y === part.y) { collided = true; break; }
                        }
                        if(collided) break;
                    }
                }
            }

            if (collided) {
                this.die();
                return;
            }

            this.body.unshift(head);
            let ate = false;
            
            // Magnet Effect
            if (this.magnetTimer > 0) {
                this.magnetTimer--;
                state.foods.forEach(f => {
                    const dx = this.body[0].x - f.x;
                    const dy = this.body[0].y - f.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < 5 && dist > 0) {
                        if(Math.abs(dx) > Math.abs(dy)) f.x += dx > 0 ? 1 : -1;
                        else f.y += dy > 0 ? 1 : -1;
                    }
                });
            }

            // Eat Food
            for (let i = state.foods.length - 1; i >= 0; i--) {
                if (head.x === state.foods[i].x && head.y === state.foods[i].y) {
                    state.foods.splice(i, 1);
                    if (this.isPlayer) { state.score += 10; updateBattleUI(); }
                    else { if(Math.random() < 0.3) this.say("ëƒ ëƒ !"); }
                    spawnItem('food'); ate = true; break;
                }
            }
            // Eat History Item
            if (!ate) {
                for (let i = state.historyItems.length - 1; i >= 0; i--) {
                    if (head.x === state.historyItems[i].x && head.y === state.historyItems[i].y) {
                        state.historyItems.splice(i, 1);
                        if (this.isPlayer) triggerQuiz();
                        spawnItem('history'); ate = true; break;
                    }
                }
            }
            // Eat Magnet
            if (!ate) {
                for (let i = state.magnets.length - 1; i >= 0; i--) {
                    if (head.x === state.magnets[i].x && head.y === state.magnets[i].y) {
                        state.magnets.splice(i, 1);
                        this.magnetTimer = 100;
                        if (this.isPlayer) { this.say("ìì„ í™œì„±í™”!"); }
                        ate = true; break;
                    }
                }
            }

            if (!ate) this.body.pop();
            
            if (!this.isPlayer) this.aiLogic();
            if (this.chatTimer > 0) this.chatTimer--;
        }
        
        aiLogic() {
            if (Math.random() > 0.1) return;
            const head = this.body[0];
            
            if (state.player && state.player.alive && Math.random() < 0.05) {
                const dist = Math.abs(head.x - state.player.body[0].x) + Math.abs(head.y - state.player.body[0].y);
                if (dist < 10) {
                     this.say(this.personality.msg[Math.floor(Math.random() * this.personality.msg.length)]);
                }
            }

            const target = state.foods[0];
            if (!target) return;
            let ndx = this.dx, ndy = this.dy;
            
            if (target.x > head.x) { ndx = 1; ndy = 0; }
            else if (target.x < head.x) { ndx = -1; ndy = 0; }
            else if (target.y > head.y) { ndx = 0; ndy = 1; }
            else if (target.y < head.y) { ndx = 0; ndy = -1; }
            
            const nextX = head.x + ndx;
            const nextY = head.y + ndy;
            if (nextX < 0 || nextX >= CONFIG.TILE_COUNT || nextY < 0 || nextY >= CONFIG.TILE_COUNT) {
                 if (ndx !== 0) { ndx = 0; ndy = 1; } else { ndx = 1; ndy = 0; }
            }

            if ((ndx !== -this.dx || ndy !== -this.dy)) {
                this.nextDx = ndx; this.nextDy = ndy;
            }
        }

        say(msg) {
            this.chatMsg = msg;
            this.chatTimer = 50;
        }

        die() { this.alive = false; if (this.isPlayer) gameOver(); }
        
        draw(ctx, cam) {
            if (!this.alive) return;
            this.body.forEach((seg, i) => {
                const sx = seg.x * CONFIG.GRID_SIZE - cam.x;
                const sy = seg.y * CONFIG.GRID_SIZE - cam.y;
                if (this.skin.id === 'rainbow') {
                    ctx.fillStyle = `hsl(${(Date.now()/10 + i*20)%360}, 70%, 50%)`;
                } else {
                    ctx.fillStyle = this.skin.color;
                }
                
                if (this.magnetTimer > 0) {
                    ctx.shadowColor = '#d946ef';
                    ctx.shadowBlur = 10;
                } else {
                    ctx.shadowBlur = 0;
                }

                ctx.globalAlpha = i === 0 ? 1 : Math.max(0.3, 1 - i / 20);
                ctx.fillRect(sx, sy, CONFIG.GRID_SIZE - 1, CONFIG.GRID_SIZE - 1);
                
                ctx.shadowBlur = 0;

                if (i === 0) {
                    ctx.fillStyle = 'white'; ctx.font = 'bold 10px Arial'; ctx.textAlign = 'center';
                    ctx.fillText(this.name, sx + 10, sy - 5);
                }
            });
            
            if (this.chatMsg && this.chatTimer > 0) {
                const head = this.body[0];
                const hx = head.x * CONFIG.GRID_SIZE - cam.x + 10;
                const hy = head.y * CONFIG.GRID_SIZE - cam.y - 20;
                ctx.font = 'bold 12px Pretendard';
                const w = ctx.measureText(this.chatMsg).width + 10;
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.roundRect(hx - w/2, hy - 15, w, 20, 5); ctx.fill();
                ctx.fillStyle = 'black';
                ctx.fillText(this.chatMsg, hx, hy);
                ctx.fillStyle = 'white';
                ctx.beginPath(); ctx.moveTo(hx, hy+5); ctx.lineTo(hx-5, hy+10); ctx.lineTo(hx+5, hy+10); ctx.fill();
            }
            ctx.globalAlpha = 1;
        }
    }

    // Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getAnalytics } from "firebase/analytics";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCO0-40KHBXb3KqVfWkJMihskT13ek8trc",
  authDomain: "server-af593.firebaseapp.com",
  projectId: "server-af593",
  storageBucket: "server-af593.firebasestorage.app",
  messagingSenderId: "489998833970",
  appId: "1:489998833970:web:abc9e410ed727ad3dddf2b",
  measurementId: "G-Y7KJ62DER2"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
const analytics = getAnalytics(app);

    // --- Shop Functions ---
    function updateShop() {
        const list = document.getElementById('skin-list');
        list.innerHTML = '';
        CONFIG.SKINS.forEach(skin => {
            const unlocked = state.userData.unlockedSkins.includes(skin.id);
            const card = document.createElement('div');
            card.className = `skin-card p-4 rounded-2xl bg-slate-900 border-2 cursor-pointer ${state.userData.selectedSkin === skin.id ? 'border-blue-500 shadow-[0_0_15px_rgba(59,130,246,0.5)]' : 'border-slate-800'}`;
            card.innerHTML = `
                <div class="w-full h-12 rounded-lg mb-3" style="background:${skin.id === 'rainbow' ? skin.color : skin.color}"></div>
                <div class="text-[11px] font-black ${skin.rarity === 'legendary' ? 'text-yellow-400' : skin.rarity === 'rare' ? 'text-blue-400' : 'text-slate-500'} uppercase mb-1">${skin.rarity}</div>
                <div class="text-sm font-bold truncate">${skin.name}</div>
                <div class="mt-2 text-xs font-bold text-slate-400">${unlocked ? (state.userData.selectedSkin === skin.id ? 'ì°©ìš©ì¤‘' : 'ë³´ìœ ì¤‘') : 'ğŸª™ ' + skin.price.toLocaleString()}</div>
            `;
            card.onclick = async () => {
                if (unlocked) { state.userData.selectedSkin = skin.id; updateShop(); await syncUserData(); }
                else if (state.userData.coins >= skin.price) {
                    state.userData.coins -= skin.price; state.userData.unlockedSkins.push(skin.id);
                    state.userData.selectedSkin = skin.id; updateUI(); updateShop(); await syncUserData();
                }
            };
            list.appendChild(card);
        });
    }

    document.getElementById('btn-gacha').onclick = async () => {
        if (state.userData.coins < CONFIG.GACHA_PRICE) return;
        state.userData.coins -= CONFIG.GACHA_PRICE;
        await syncUserData();
        updateUI();

        const overlay = document.getElementById('gacha-overlay');
        const box = document.getElementById('gacha-box');
        const status = document.getElementById('gacha-status');
        const sub = document.getElementById('gacha-sub-status');
        const newSkinDiv = document.getElementById('gacha-new-skin');
        const btnClose = document.getElementById('btn-gacha-close');

        overlay.classList.remove('hidden');
        box.classList.add('shaking');
        status.innerText = "ìŠ¤í‚¨ ë°•ìŠ¤ ê°œë´‰ ì¤‘...";
        sub.innerText = "ìš´ëª…ì˜ ì‹œê°„ì„ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”!";
        newSkinDiv.classList.add('hidden');
        btnClose.classList.add('hidden');

        setTimeout(async () => {
            box.classList.remove('shaking');
            box.innerText = "âœ¨";
            status.innerText = "ìŠ¤í‚¨ íšë“!";
            
            const rand = Math.random();
            let pool = [];
            if (rand < 0.05) pool = CONFIG.SKINS.filter(s => s.rarity === 'legendary');
            else if (rand < 0.25) pool = CONFIG.SKINS.filter(s => s.rarity === 'rare');
            else pool = CONFIG.SKINS.filter(s => s.rarity === 'common');
            
            const wonSkin = pool[Math.floor(Math.random() * pool.length)];
            
            sub.innerText = `${wonSkin.rarity.toUpperCase()} ë“±ê¸‰ ìŠ¤í‚¨ì„ ë°œê²¬í–ˆìŠµë‹ˆë‹¤!`;
            newSkinDiv.classList.remove('hidden');
            document.getElementById('gacha-skin-preview').style.background = wonSkin.color;
            document.getElementById('gacha-skin-name').innerText = wonSkin.name;
            document.getElementById('gacha-skin-name').style.color = wonSkin.rarity === 'legendary' ? '#fbbf24' : wonSkin.rarity === 'rare' ? '#3b82f6' : '#fff';
            
            if (!state.userData.unlockedSkins.includes(wonSkin.id)) {
                state.userData.unlockedSkins.push(wonSkin.id);
                await syncUserData();
            } else {
                state.userData.coins += 100;
                sub.innerText += " (ì¤‘ë³µ ë³´ìƒ ğŸª™100 ì§€ê¸‰)";
                await syncUserData();
            }
            btnClose.classList.remove('hidden');
        }, 2000);
    };

    document.getElementById('btn-gacha-close').onclick = () => {
        document.getElementById('gacha-overlay').classList.add('hidden');
        document.getElementById('gacha-box').innerText = "ğŸ";
        updateShop();
        updateUI();
    };

    const endMiniGame = async () => {
        clearInterval(state.mgInterval);
        const gain = state.mgScore * 5;
        state.userData.coins += gain;
        await syncUserData();
        
        let areaId = `minigame-${state.activeMiniGame}-area`;
        const area = document.getElementById(areaId);
        
        // Add Result Overlay with Retry
        const overlay = document.createElement('div');
        overlay.className = "absolute inset-0 bg-black/90 z-50 flex flex-col items-center justify-center result-overlay";
        overlay.innerHTML = `
            <div class="text-4xl font-black text-yellow-400 mb-2">TIME OVER!</div>
            <div class="text-xl mb-6">íšë“ ì½”ì¸: ğŸª™ ${gain}</div>
            <div class="flex gap-4">
                <button onclick="window.startMiniGame('${state.activeMiniGame}')" class="bg-blue-600 hover:bg-blue-500 text-white px-8 py-3 rounded-full font-bold transition-all">ë‹¤ì‹œ í•˜ê¸°</button>
                <button onclick="window.switchScreen('minigame-hub')" class="bg-white hover:bg-gray-200 text-black px-8 py-3 rounded-full font-bold transition-all">í—ˆë¸Œë¡œ ëŒì•„ê°€ê¸°</button>
            </div>
        `;
        area.appendChild(overlay);
    };

    // --- UI Events ---
    document.getElementById('btn-goto-shop').onclick = () => { updateShop(); window.switchScreen('shop'); };
    document.getElementById('btn-goto-minigame-hub').onclick = () => window.switchScreen('minigame-hub');
    document.getElementById('btn-goto-community').onclick = () => window.switchScreen('community');
    document.getElementById('nickname-input').onchange = (e) => { state.userData.nickname = e.target.value || "ì´ˆë³´ì§€ë ì´"; syncUserData(); };

    // --- Battle Core ---
    function initGame(mode) {
        // Fix: Safety check for multiplayer.
        if (mode === 'multi' && !state.user) return;

        state.gameMode = mode;
        window.switchScreen('battle');
        const nick = document.getElementById('nickname-input').value || "ì´ˆë³´ì§€ë ì´";
        document.getElementById('game-mode-display').innerText = `MODE: ${mode === 'single' ? 'SINGLE' : 'ONLINE (BETA)'}`;

        // Fix: Use fallback ID for single player if auth is not ready
        const currentUid = state.user ? state.user.uid : 'guest-player-' + Math.floor(Math.random() * 10000);

        state.player = new Snake(currentUid, 
            Math.random() * (CONFIG.TILE_COUNT - 10) + 5, 
            Math.random() * (CONFIG.TILE_COUNT - 10) + 5, 
            state.userData.selectedSkin, nick, true);
        
        state.foods = []; state.historyItems = []; state.ais = []; state.remotePlayers = {}; state.magnets = [];
        for(let i=0; i<150; i++) spawnItem('food');
        for(let i=0; i<5; i++) spawnItem('magnet'); 
        for(let i=0; i<5; i++) spawnItem('history');
        
        if (mode === 'single') {
            state.ais = Array(8).fill(0).map((_,i) => new Snake('ai'+i, Math.random()*100, Math.random()*100, CONFIG.SKINS[Math.floor(Math.random()*3)].id, 'AI_'+i));
        } else {
            if(state.unsubscribePlayers) state.unsubscribePlayers();
            listenMultiplayer();
        }

        state.isPaused = false;
        state.score = 0; updateBattleUI();
        const canvas = document.getElementById('gameCanvas');
        canvas.width = 800; canvas.height = 500;
        
        if(state.gameLoop) clearInterval(state.gameLoop);
        state.gameLoop = setInterval(run, 100);
    }

    document.getElementById('btn-start-single').onclick = () => initGame('single');
    document.getElementById('btn-start-multi').onclick = () => { if(state.user) initGame('multi'); };

    function listenMultiplayer() {
        const q = query(collection(state.db, 'artifacts', appId, 'public', 'data', 'players'));
        state.unsubscribePlayers = onSnapshot(q, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                const data = change.doc.data();
                if (state.user && data.uid === state.user.uid) return; // Fix: Check state.user
                if (change.type === "added" || change.type === "modified") {
                    if (!state.remotePlayers[data.uid]) {
                        state.remotePlayers[data.uid] = new Snake(data.uid, data.body[0].x, data.body[0].y, data.skin, data.nickname);
                    }
                    state.remotePlayers[data.uid].body = data.body;
                    state.remotePlayers[data.uid].skin = CONFIG.SKINS.find(s=>s.id === data.skin) || CONFIG.SKINS[0];
                    state.remotePlayers[data.uid].name = data.nickname;
                }
                if (change.type === "removed") delete state.remotePlayers[data.uid];
            });
        });
    }

    async function updateMultiplayerState() {
        if (!state.player || state.gameMode !== 'multi' || !state.user) return; // Fix: check state.user
        const now = Date.now();
        if (now - state.lastMultiplayerUpdate > 200) {
            state.lastMultiplayerUpdate = now;
            await setDoc(doc(state.db, 'artifacts', appId, 'public', 'data', 'players', state.user.uid), {
                uid: state.user.uid, nickname: state.player.name, skin: state.player.skin.id, body: state.player.body, timestamp: serverTimestamp()
            });
        }
    }

    function run() {
        if (state.isPaused || !state.player) return;
        
        const iterations = state.isDashing ? 2 : 1;
        for(let i=0; i<iterations; i++) {
            state.player.update();
            if(!state.player.alive) break;
        }

        if (state.gameMode === 'multi') updateMultiplayerState();
        else state.ais.forEach(a => a.update());

        state.camera.x = state.player.body[0].x * CONFIG.GRID_SIZE - 400;
        state.camera.y = state.player.body[0].y * CONFIG.GRID_SIZE - 250;
        
        const ctx = document.getElementById('gameCanvas').getContext('2d');
        ctx.fillStyle = '#020617'; ctx.fillRect(0, 0, 800, 500);
        
        ctx.strokeStyle = '#1e293b'; ctx.lineWidth = 0.5;
        const startX = Math.floor(state.camera.x / 20) * 20;
        const startY = Math.floor(state.camera.y / 20) * 20;
        for(let x = startX; x < startX + 820; x += 20) {
            ctx.beginPath(); ctx.moveTo(x - state.camera.x, 0); ctx.lineTo(x - state.camera.x, 500); ctx.stroke();
        }
        for(let y = startY; y < startY + 520; y += 20) {
            ctx.beginPath(); ctx.moveTo(0, y - state.camera.y); ctx.lineTo(800, y - state.camera.y); ctx.stroke();
        }

        ctx.fillStyle = '#10b981'; state.foods.forEach(f => ctx.fillRect(f.x*20-state.camera.x, f.y*20-state.camera.y, 10, 10));
        ctx.fillStyle = '#fbbf24'; state.historyItems.forEach(h => ctx.fillRect(h.x*20-state.camera.x, h.y*20-state.camera.y, 12, 12));
        ctx.fillStyle = '#d946ef'; state.magnets.forEach(m => {
             ctx.beginPath(); ctx.arc(m.x*20-state.camera.x+10, m.y*20-state.camera.y+10, 8, 0, Math.PI*2); ctx.fill();
        });

        state.player.draw(ctx, state.camera);
        if (state.gameMode === 'multi') Object.values(state.remotePlayers).forEach(p => p.draw(ctx, state.camera));
        else state.ais.forEach(a => a.draw(ctx, state.camera));

        drawMinimap();
    }

    function drawMinimap() {
        const ctx = document.getElementById('minimap').getContext('2d');
        const scale = 150 / CONFIG.TILE_COUNT;
        ctx.clearRect(0,0,150,150);
        
        ctx.fillStyle = '#3b82f6';
        const h = state.player.body[0];
        ctx.beginPath(); ctx.arc(h.x * scale, h.y * scale, 3, 0, Math.PI*2); ctx.fill();

        ctx.fillStyle = '#ef4444';
        if(state.gameMode === 'multi') {
            Object.values(state.remotePlayers).forEach(p => {
                ctx.beginPath(); ctx.arc(p.body[0].x * scale, p.body[0].y * scale, 2, 0, Math.PI*2); ctx.fill();
            });
        } else {
            state.ais.forEach(p => {
                if(!p.alive) return;
                ctx.beginPath(); ctx.arc(p.body[0].x * scale, p.body[0].y * scale, 2, 0, Math.PI*2); ctx.fill();
            });
        }

        ctx.fillStyle = '#10b981';
        state.foods.forEach(f => {
            ctx.fillRect(f.x * scale, f.y * scale, 1, 1);
        });
    }

    function spawnItem(type) {
        const pos = { x: Math.floor(Math.random() * CONFIG.TILE_COUNT), y: Math.floor(Math.random() * CONFIG.TILE_COUNT) };
        if (type === 'history') state.historyItems.push(pos);
        else if (type === 'magnet') state.magnets.push(pos);
        else state.foods.push(pos);
    }

    function updateBattleUI() {
        document.getElementById('battle-score').innerText = Math.floor(state.score);
        document.getElementById('battle-coin-potential').innerText = `ğŸª™ ${Math.floor(state.score/5)}`;
    }

    async function gameOver() {
        state.isPaused = true;
        clearInterval(state.gameLoop);
        const gain = Math.floor(state.score / 5);
        state.userData.coins += gain;
        await syncUserData();
        
        if (state.gameMode === 'multi' && state.user) { // Fix: check state.user
             await deleteDoc(doc(state.db, 'artifacts', appId, 'public', 'data', 'players', state.user.uid));
        }

        document.getElementById('final-coin-gain').innerText = `ğŸª™ ${gain}`;
        document.getElementById('gameover-overlay').classList.remove('hidden');
    }

    function triggerQuiz() {
        state.isPaused = true;
        const quiz = CONFIG.QUIZZES[Math.floor(Math.random() * CONFIG.QUIZZES.length)];
        const overlay = document.getElementById('quiz-overlay');
        document.getElementById('quiz-question').innerText = quiz.q;
        const options = document.getElementById('quiz-options');
        options.innerHTML = '';
        quiz.a.forEach((txt, i) => {
            const b = document.createElement('button');
            b.className = "w-full text-left p-4 rounded-xl border border-slate-200 hover:bg-blue-50 font-bold transition-colors";
            b.innerText = txt;
            b.onclick = async () => {
                if (i === quiz.c) { state.score += 500; updateBattleUI(); }
                overlay.style.display = 'none'; state.isPaused = false;
            };
            options.appendChild(b);
        });
        overlay.style.display = 'block';
    }

    function listenGameChat() {
        const q = query(collection(state.db, 'artifacts', appId, 'public', 'data', 'chat'));
        onSnapshot(q, (snapshot) => {
            const messages = snapshot.docs.map(d => d.data()).sort((a,b) => a.timestamp - b.timestamp).slice(-20);
            const chatBox = document.getElementById('chat-messages');
            chatBox.innerHTML = messages.map(m => `
                <div class="mb-1"><span class="text-blue-400 font-bold">${m.sender}:</span> <span class="text-white">${m.text}</span></div>
            `).join('');
            chatBox.scrollTop = chatBox.scrollHeight;
            
            if (state.gameMode === 'single' && messages.length > 0) {
                const lastMsg = messages[messages.length-1];
                if (state.user && lastMsg.uid === state.user.uid) { // Fix: Check state.user
                    state.ais.forEach(ai => {
                        if (Math.random() < 0.3) {
                             if (lastMsg.text.includes("ì•ˆë…•")) ai.say("ë°˜ê°€ì›Œ!");
                             else if (lastMsg.text.includes("ë°”ë³´")) ai.say("ë„ˆê°€ ë”!");
                             else ai.say("ì§‘ì¤‘í•´!");
                        }
                    });
                }
            }
        }, (err) => {});
    }

    function listenCommunity() {
        const q = query(collection(state.db, 'artifacts', appId, 'public', 'data', 'community'));
        onSnapshot(q, (snapshot) => {
            const posts = snapshot.docs.map(d => d.data()).sort((a,b) => (b.timestamp || 0) - (a.timestamp || 0));
            const container = document.getElementById('comm-posts');
            container.innerHTML = posts.map(p => `
                <div class="bg-slate-800 border border-slate-700 p-5 rounded-2xl shadow-lg">
                    <div class="flex justify-between items-center mb-2">
                        <span class="font-black text-indigo-400 text-sm">${p.nickname}</span>
                        <span class="text-[10px] text-slate-500 font-mono">${p.timestamp ? new Date(p.timestamp.seconds * 1000).toLocaleTimeString() : 'ë°©ê¸ˆ'}</span>
                    </div>
                    <div class="text-white text-sm leading-relaxed">${p.content}</div>
                </div>
            `).join('');
        }, (err) => {});
    }

    async function sendChat(text) {
        if (!text.trim() || !state.user) return;
        await addDoc(collection(state.db, 'artifacts', appId, 'public', 'data', 'chat'), {
            text, sender: state.userData.nickname, uid: state.user.uid, timestamp: Date.now()
        });
    }

    document.getElementById('chat-input-field').addEventListener('keypress', (e) => {
        if (e.key === 'Enter') { sendChat(e.target.value); e.target.value = ''; }
    });

    document.getElementById('btn-comm-post').onclick = async () => {
        const input = document.getElementById('comm-input');
        if (!input.value.trim() || !state.user) return;
        await addDoc(collection(state.db, 'artifacts', appId, 'public', 'data', 'community'), {
            content: input.value, nickname: state.userData.nickname, uid: state.user.uid, timestamp: serverTimestamp()
        });
        input.value = '';
    };

    // --- Inputs ---
    window.addEventListener('keydown', e => {
        if (!state.player || state.isPaused) return;
        const k = e.key.toLowerCase();
        if ((k === 'w' || k === 'arrowup') && state.player.dy !== 1) { state.player.nextDx = 0; state.player.nextDy = -1; }
        if ((k === 's' || k === 'arrowdown') && state.player.dy !== -1) { state.player.nextDx = 0; state.player.nextDy = 1; }
        if ((k === 'a' || k === 'arrowleft') && state.player.dx !== 1) { state.player.nextDx = -1; state.player.nextDy = 0; }
        if ((k === 'd' || k === 'arrowright') && state.player.dx !== -1) { state.player.nextDx = 1; state.player.nextDy = 0; }
        
        if (e.code === 'Space') {
            state.isDashing = true;
            document.getElementById('dash-effect').classList.add('active');
            document.getElementById('battle-dash-text').classList.remove('hidden');
        }
    });

    window.addEventListener('keyup', e => {
        if (e.code === 'Space') {
            state.isDashing = false;
            document.getElementById('dash-effect').classList.remove('active');
            document.getElementById('battle-dash-text').classList.add('hidden');
        }
    });
    
    // Mobile Dash
    const dashBtn = document.getElementById('mobile-dash-btn');
    dashBtn.addEventListener('touchstart', (e) => {
        e.preventDefault();
        state.isDashing = true;
        document.getElementById('dash-effect').classList.add('active');
        document.getElementById('battle-dash-text').classList.remove('hidden');
    });
    dashBtn.addEventListener('touchend', (e) => {
        e.preventDefault();
        state.isDashing = false;
        document.getElementById('dash-effect').classList.remove('active');
        document.getElementById('battle-dash-text').classList.add('hidden');
    });

    initFirebase();
</script>
</body>
</html>
